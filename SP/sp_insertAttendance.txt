USE [Student-Attendance-System]
GO
/****** Object:  StoredProcedure [dbo].[sp_insertAttendance]    Script Date: 2/12/2026 10:17:55 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[sp_insertAttendance]
    @id INT
AS
BEGIN
    SET NOCOUNT ON;
 
    DECLARE 
        @studentID INT,
        @status VARCHAR(10),
        @today DATE = CAST(GETDATE() AS DATE),
        @now TIME = CAST(SYSDATETIME() AS TIME),
        @threshold TIME = '09:15:00',
		@attendanceID INT;
 
    -- Validate registration number (hashID)
    SELECT @studentID = studentID
    FROM dbo.hashtable
    WHERE id = @id;
 
    IF @studentID IS NULL
    BEGIN
        THROW 50001, 'Invalid registration number', 1;
    END
 
    -- Prevent duplicate attendance
    IF EXISTS (
        SELECT 1
        FROM dbo.attendance
        WHERE studentID = @studentID
          AND [date] = @today
    )
    BEGIN
        THROW 50002, 'Attendance already marked for today', 1;
    END
 
    --  Determine attendance status
    SET @status =
        CASE
            WHEN @now <= @threshold THEN 'PRESENT'
            ELSE 'LATE'
        END;
 
    --  Insert attendance
    INSERT INTO dbo.attendance (studentID, [date], in_time, status)
    VALUES (@studentID, @today, @now, @status);
 
	SET @attendanceID = CAST(SCOPE_IDENTITY() AS INT);
 
    -- return
    SELECT
		@attendanceID AS id,
        @studentID AS studentID,     
        @today AS date,
        @now AS in_time,
		@status AS status;
END;